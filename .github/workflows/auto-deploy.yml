name: ğŸš€ Auto Deploy BirdEye Sniper Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

jobs:
  validate-and-trigger:
    name: ğŸ¯ Validate & Trigger Self-Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies for Testing
      run: |
        echo "ğŸ”§ Installing dependencies for validation..."
        npm ci
        
    - name: ğŸ§ª Run Tests (if available)
      run: |
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          echo "ğŸ§ª Running tests..."
          npm test || echo "âš ï¸ Tests failed but continuing..."
        else
          echo "ğŸ“ No tests found, skipping..."
        fi
      continue-on-error: true

    - name: ğŸ” Validate Project Structure
      run: |
        echo "ğŸ” Validating project structure..."
        
        # Check required files
        if [ ! -f "index.js" ]; then
          echo "âŒ index.js not found!"
          exit 1
        fi
        
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found!"
          exit 1
        fi
        
        if [ ! -f "ecosystem.config.js" ]; then
          echo "âŒ ecosystem.config.js not found!"
          exit 1
        fi
        
        if [ ! -d "src" ]; then
          echo "âŒ src directory not found!"
          exit 1
        fi
        
        echo "âœ… Project structure validated"

    - name: ğŸ“‹ Get Deployment Info
      id: deploy-info
      run: |
        echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
        echo "deploy_time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT

    - name: ğŸš€ Trigger Self-Deployment (Optional Webhook)
      run: |
        echo "ğŸš€ Attempting to trigger self-deployment..."
        
        # Try to trigger webhook on your server (optional)
        WEBHOOK_URL="${{ secrets.WEBHOOK_URL }}"
        
        if [ -n "$WEBHOOK_URL" ]; then
          echo "ğŸ“¡ Sending webhook to: $WEBHOOK_URL"
          
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            -H "X-GitHub-Event: push" \
            -d '{
              "ref": "refs/heads/main",
              "repository": {
                "name": "bird",
                "full_name": "${{ github.repository }}"
              },
              "head_commit": {
                "id": "${{ steps.deploy-info.outputs.commit_hash }}",
                "message": "${{ steps.deploy-info.outputs.commit_message }}"
              },
              "deploy_info": {
                "commit_hash": "${{ steps.deploy-info.outputs.commit_hash }}",
                "commit_message": "${{ steps.deploy-info.outputs.commit_message }}",
                "deploy_time": "${{ steps.deploy-info.outputs.deploy_time }}",
                "author": "${{ steps.deploy-info.outputs.author }}",
                "triggered_by": "github-actions"
              }
            }' \
            --max-time 30 \
            --retry 2 \
            --retry-delay 3 \
            || echo "âš ï¸ Webhook not configured or failed - that's OK!"
        else
          echo "ğŸ“ No webhook URL configured"
          echo "ğŸ”„ Your server should auto-pull changes via git hooks or cron job"
        fi
        
        echo "âœ… Validation completed - deployment trigger sent"

    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ“Š GitHub Actions Summary:"
        echo "================================"
        echo "ğŸ“‹ Commit: ${{ steps.deploy-info.outputs.commit_hash }}"
        echo "ğŸ’¬ Message: ${{ steps.deploy-info.outputs.commit_message }}"
        echo "ğŸ‘¤ Author: ${{ steps.deploy-info.outputs.author }}"
        echo "â° Time: ${{ steps.deploy-info.outputs.deploy_time }}"
        echo "ğŸ¯ Branch: main"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo ""
        echo "âœ… Code validation successful!"
        echo "ğŸš€ Your server should handle deployment automatically"
        echo "ğŸ“± Check your Telegram for deployment notifications"
        echo ""
        echo "ğŸ”§ How deployment works:"
        echo "1. This GitHub Action validates your code"
        echo "2. Your server runs a cron job or git hook to pull changes"
        echo "3. Auto-deploy script handles the actual deployment"
        echo "4. Telegram notification sent with deployment status"
